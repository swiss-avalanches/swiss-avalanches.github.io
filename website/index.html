<!DOCTYPE html>
<html>
<head>

  <title>Quick Start - Leaflet</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>

<div id="mapid" style="height: 600px;"></div>
<div id="theform">
  <input type="text" name="regex" value=".*" placeholder="regex" style="width: 100%;" id="regexField"><br>
  <input type="range" min="0" max="100" value="50" class="slider" id="dateRange" style="width: 100%">
</div>
<p id="filename"></p>

<script>
  var regex = ".*"

  var mymap = L.map('mapid').setView([46.875893, 8.289321], 8);

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
      '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    id: 'mapbox.streets'
  }).addTo(mymap);

  all_files = {}
  all_names = []
  filtered_names = []
  download_remaining = 999

  function download_file(f) {
    $.get('http://localhost:5000/' + f).done(function(res) {
        all_files[f] = res
        all_names.push(f)
        download_remaining -= 1
        if (download_remaining == 0) {
          console.log('download done', all_files)
          all_names.sort()
          filtered_names = all_names
        }
      });
  }

  function download_list(ls) {
    download_remaining = ls.length
    $('#dateRange').attr('max', ls.length - 1);
    for (var i in ls) {
      file = ls[i]
      download_file(file)
    }
  }

  function update_slider() {
    reg = new RegExp(regex)
    filtered_names = all_names.filter(function(item) {
      return reg.test(item)
    })
    $('#dateRange').attr('max', filtered_names.length - 1);
  }

  $.getJSON('http://localhost:5000/').done(download_list)


  function color_style(feature) {
    console.log(feature, feature['properties'], feature['properties']['danger_level'])
    if (feature['properties'] && feature['properties']['danger_level']) {
        switch (feature['properties']['danger_level']) {
            case 1: return {color: "#ccff66"};
            case 2:   return {color: "#ffff00"};
            case 3:   return {color: "#ff9900"};
            case 4:   return {color: "#ff0000"};
            case 5:   return {color: "#9102ff"};  // TODO
        }
    } else {
        return {color: "blue"}
    }
  }

  geojsonLayer = L.geoJSON()

  $("#dateRange").on('input', function() {
    index = $(this).val()
    filename = filtered_names[index]
    $('#filename').text(filename)
    geojsonFeature = all_files[filename]

    if (geojsonLayer)
        mymap.removeLayer(geojsonLayer)

    geojsonLayer = L.geoJSON(geojsonFeature, {style: color_style})
    geojsonLayer.addTo(mymap);
  })

  $("#regexField").on('input', function() {
    regex = $("#regexField").val()
    update_slider()
  })

</script>



</body>
</html>

